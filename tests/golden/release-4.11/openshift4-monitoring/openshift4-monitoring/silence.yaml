apiVersion: v1
data:
  silence: "#!/bin/bash\nset -euo pipefail\n\ncurl_opts=( https://alertmanager-main.openshift-monitoring.svc.cluster.local:9095/api/v2/silences\
    \ --cacert /etc/ssl/certs/serving-certs/service-ca.crt --header 'Content-Type:\
    \ application/json' --header \"Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)\"\
    \ --resolve \"alertmanager-main.openshift-monitoring.svc.cluster.local:9095:$(getent\
    \ hosts alertmanager-operated.openshift-monitoring.svc.cluster.local | awk '{print\
    \ $1}' | head -n 1)\" --silent )\n\nfor silence in $(printf %s \"${SILENCES_JSON}\"\
    \ | jq -cr '.[]'); do\n  comment=$(printf %s \"${silence}\" | jq -r '.comment')\n\
    \n  body=$(printf %s \"$silence\" | \\\n    jq \\\n      --arg startsAt \"$(date\
    \ -u +'%Y-%m-%dT%H:%M:%S')\" \\\n      --arg endsAt \"$(date -u +'%Y-%m-%dT%H:%M:%S'\
    \ --date '+1 year')\" \\\n      --arg createdBy \"Kubernetes object \\`cronjob/silence\\\
    ` in the monitoring namespace\" \\\n      '.startsAt = $startsAt | .endsAt = $endsAt\
    \ | .createdBy = $createdBy'\n  )\n\n  id=$(curl \"${curl_opts[@]}\" | jq -r \"\
    .[] | select(.status.state == \\\"active\\\") | select(.comment == \\\"${comment}\\\
    \") | .id\" | head -n 1)\n  if [ -n \"${id}\" ]; then\n    body=$(printf %s \"\
    ${body}\" | jq --arg id \"${id}\" '.id = $id')\n  fi\n\n  curl \"${curl_opts[@]}\"\
    \ -XPOST -d \"${body}\"\ndone\n"
  silences.json: '[{"comment":"Silence non syn alerts","matchers":[{"isRegex":true,"name":"alertname","value":".+"},{"isRegex":false,"name":"syn","value":""}]}]'
kind: ConfigMap
metadata:
  annotations: {}
  labels:
    name: silence
  name: silence
  namespace: openshift-monitoring
---
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  annotations: {}
  labels:
    name: silence
  name: silence
  namespace: openshift-monitoring
spec:
  concurrencyPolicy: Forbid
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      completions: 1
      parallelism: 1
      template:
        metadata:
          labels:
            name: silence
        spec:
          containers:
            - args: []
              command:
                - /usr/local/bin/silence
              env:
                - name: SILENCES_JSON
                  valueFrom:
                    configMapKeyRef:
                      key: silences.json
                      name: silence
              image: quay.io/appuio/oc:v4.9
              imagePullPolicy: IfNotPresent
              name: silence
              ports: []
              stdin: false
              tty: false
              volumeMounts:
                - mountPath: /etc/ssl/certs/serving-certs/
                  name: ca-bundle
                  readOnly: true
                - mountPath: /usr/local/bin/silence
                  name: scripts
                  readOnly: true
                  subPath: silence
          imagePullSecrets: []
          initContainers: []
          nodeSelector:
            node-role.kubernetes.io/infra: ''
          restartPolicy: Never
          serviceAccountName: prometheus-k8s
          terminationGracePeriodSeconds: 30
          volumes:
            - configMap:
                defaultMode: 288
                name: serving-certs-ca-bundle
              name: ca-bundle
            - configMap:
                defaultMode: 360
                name: silence
              name: scripts
  schedule: 0 */4 * * *
  successfulJobsHistoryLimit: 3
